<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PayPal IPN Test Tool</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        h1 {
            color: #333;
            text-align: center;
            margin-bottom: 30px;
        }
        .test-section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        button {
            background-color: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 5px;
            cursor: pointer;
            margin: 5px;
            font-size: 14px;
        }
        button:hover {
            background-color: #0056b3;
        }
        button:disabled {
            background-color: #6c757d;
            cursor: not-allowed;
        }
        .result {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-family: monospace;
            font-size: 12px;
            white-space: pre-wrap;
        }
        .success {
            background-color: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
        }
        .error {
            background-color: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
        }
        .info {
            background-color: #d1ecf1;
            border: 1px solid #bee5eb;
            color: #0c5460;
        }
        .instructions {
            background-color: #fff3cd;
            border: 1px solid #ffeaa7;
            color: #856404;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üß™ PayPal IPN Test Tool</h1>
        
        <div class="instructions">
            <strong>Instructions:</strong><br>
            1. Make sure your local server is running on http://localhost:3000<br>
            2. Click any of the test buttons below to send fake PayPal IPNs<br>
            3. Check the results and then visit <a href="http://localhost:3000/admin/ipn-logs" target="_blank">IPN Logs</a> to see the captured data
        </div>

        <div class="test-section">
            <h3>‚úÖ Successful Payment Test</h3>
            <p>Simulates a completed PayPal payment</p>
            <button onclick="sendTestIPN('Completed', 'SUCCESS')">Send Successful Payment IPN</button>
            <div id="result-success" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>‚è≥ Pending Payment Test</h3>
            <p>Simulates a pending PayPal payment</p>
            <button onclick="sendTestIPN('Pending', 'PENDING')">Send Pending Payment IPN</button>
            <div id="result-pending" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>‚ùå Failed Payment Test</h3>
            <p>Simulates a failed PayPal payment</p>
            <button onclick="sendTestIPN('Failed', 'FAILED')">Send Failed Payment IPN</button>
            <div id="result-failed" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üîç Invalid Order Test</h3>
            <p>Simulates an IPN with an invalid order ID (should cause an error)</p>
            <button onclick="sendTestIPN('Completed', 'INVALID_ORDER')">Send Invalid Order IPN</button>
            <div id="result-invalid" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üéØ Custom Test</h3>
            <p>Send a custom IPN with your own data</p>
            <button onclick="sendCustomIPN()">Send Custom IPN</button>
            <div id="result-custom" class="result" style="display: none;"></div>
        </div>

        <div class="test-section">
            <h3>üìä View Results</h3>
            <p>Open the IPN logs page to see all captured data</p>
            <button onclick="window.open('http://localhost:3000/admin/ipn-logs', '_blank')">Open IPN Logs</button>
        </div>
    </div>

    <script>
        // Test PayPal IPN data template
        const testIPNData = {
          payment_status: 'Completed',
          txn_id: `TEST_TXN_${Date.now()}`,
          receiver_email: 'misstaylorflynn@gmail.com', // Updated to match site settings
          business: 'misstaylorflynn@gmail.com', // PayPal sometimes uses this field instead
          custom: '550e8400-e29b-41d4-a716-446655440000', // Valid UUID format for testing
          mc_gross: '25.00',
          mc_currency: 'USD',
          payment_date: new Date().toISOString(),
          payer_email: 'testpayer@example.com',
          payer_id: 'TEST_PAYER_ID',
          payment_type: 'instant',
          notify_version: '3.9',
          verify_sign: 'TEST_SIGNATURE',
          item_name: 'Test Product',
          item_number: 'PROD_001',
          quantity: '1',
          mc_fee: '1.25',
          mc_handling: '0.00',
          mc_shipping: '0.00',
          tax: '0.00',
          address_city: 'Test City',
          address_country: 'US',
          address_name: 'Test User',
          address_state: 'CA',
          address_street: '123 Test St',
          address_zip: '12345'
        }

        async function sendTestIPN(paymentStatus, testType) {
            const resultDiv = document.getElementById(`result-${testType.toLowerCase().replace('_', '-')}`);
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'üöÄ Sending IPN...';

            try {
                // Create IPN data
                const ipnData = { ...testIPNData };
                ipnData.payment_status = paymentStatus;
                ipnData.txn_id = `${testType}_TXN_${Date.now()}`;
                
                if (testType === 'INVALID_ORDER') {
                    ipnData.custom = 'non-existent-order-id';
                }

                // Convert to URL-encoded form data
                const formData = new URLSearchParams();
                for (const [key, value] of Object.entries(ipnData)) {
                    formData.append(key, value);
                }

                console.log('üìã Sending IPN Data:', ipnData);

                const response = await fetch('http://localhost:3000/api/paypal/ipn', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'User-Agent': 'Test-IPN-Sender/1.0'
                    },
                    body: formData.toString()
                });

                const result = await response.text();
                
                console.log('üì§ Response Status:', response.status);
                console.log('üì§ Response Body:', result);

                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ IPN sent successfully!\n\nStatus: ${response.status}\nResponse: ${result}\n\nüîç Check your IPN logs at: http://localhost:3000/admin/ipn-logs`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå IPN failed!\n\nStatus: ${response.status}\nResponse: ${result}\n\nThis is expected for invalid order tests.`;
                }

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error sending IPN:\n\n${error.message}\n\nMake sure your server is running on http://localhost:3000`;
                console.error('Error sending IPN:', error);
            }
        }

        async function sendCustomIPN() {
            const resultDiv = document.getElementById('result-custom');
            resultDiv.style.display = 'block';
            resultDiv.className = 'result info';
            resultDiv.textContent = 'üöÄ Sending custom IPN...';

            try {
                // Create custom IPN data
                const customIPNData = {
                    payment_status: 'Completed',
                    txn_id: 'CUSTOM_TXN_' + Date.now(),
                    receiver_email: 'test@uoking.com',
                    custom: 'custom-order-456',
                    mc_gross: '50.00',
                    mc_currency: 'USD',
                    payment_date: new Date().toISOString(),
                    payer_email: 'custompayer@example.com',
                    payer_id: 'CUSTOM_PAYER_ID',
                    payment_type: 'instant',
                    notify_version: '3.9',
                    verify_sign: 'CUSTOM_SIGNATURE',
                    item_name: 'Custom Test Product',
                    item_number: 'CUSTOM_PROD_001',
                    quantity: '2',
                    mc_fee: '2.50',
                    mc_handling: '0.00',
                    mc_shipping: '0.00',
                    tax: '0.00'
                };

                // Convert to URL-encoded form data
                const formData = new URLSearchParams();
                for (const [key, value] of Object.entries(customIPNData)) {
                    formData.append(key, value);
                }

                console.log('üìã Sending Custom IPN Data:', customIPNData);

                const response = await fetch('http://localhost:3000/api/paypal/ipn', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'User-Agent': 'Test-IPN-Sender/1.0'
                    },
                    body: formData.toString()
                });

                const result = await response.text();
                
                console.log('üì§ Response Status:', response.status);
                console.log('üì§ Response Body:', result);

                if (response.ok) {
                    resultDiv.className = 'result success';
                    resultDiv.textContent = `‚úÖ Custom IPN sent successfully!\n\nStatus: ${response.status}\nResponse: ${result}\n\nüîç Check your IPN logs at: http://localhost:3000/admin/ipn-logs`;
                } else {
                    resultDiv.className = 'result error';
                    resultDiv.textContent = `‚ùå Custom IPN failed!\n\nStatus: ${response.status}\nResponse: ${result}`;
                }

            } catch (error) {
                resultDiv.className = 'result error';
                resultDiv.textContent = `‚ùå Error sending custom IPN:\n\n${error.message}\n\nMake sure your server is running on http://localhost:3000`;
                console.error('Error sending custom IPN:', error);
            }
        }

        // Add some helpful console commands
        console.log('üß™ PayPal IPN Test Tool loaded!');
        console.log('Available functions:');
        console.log('- sendTestIPN(paymentStatus, testType)');
        console.log('- sendCustomIPN()');
        console.log('Example: sendTestIPN("Completed", "SUCCESS")');
    </script>
</body>
</html>
